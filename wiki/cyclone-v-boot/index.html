<!doctype html><html lang=en><head><title>Simplified Boot Flow for the Cyclone V :: stumbl.ing</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Table of Contents Executing User Software PreLoader Image Requirements PreLoader Actions PreLoader Memory State Bootloader execution (u-boot) Operating System Boot The Cyclone V Technical Reference Manual details the boot flow for the common &amp;ldquo;running linux to boot your FPGA&amp;rdquo; usecase like so:
Figure 1: Technical Reference Manual Diagram of Typical Boot Flow But because everything after the BootROM is classified as &amp;ldquo;user software,&amp;rdquo; there is not much described in the manual."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://stumbl.ing/wiki/cyclone-v-boot/><meta property="og:locale" content="en"><meta property="og:title" content="Simplified Boot Flow for the Cyclone V :: stumbl.ing"><meta property="og:description" content="Table of Contents Executing User Software PreLoader Image Requirements PreLoader Actions PreLoader Memory State Bootloader execution (u-boot) Operating System Boot The Cyclone V Technical Reference Manual details the boot flow for the common &amp;ldquo;running linux to boot your FPGA&amp;rdquo; usecase like so:
Figure 1: Technical Reference Manual Diagram of Typical Boot Flow But because everything after the BootROM is classified as &amp;ldquo;user software,&amp;rdquo; there is not much described in the manual."><meta property="og:type" content="article"><meta property="article:published_time" content="2024-02-18 00:00:00 +0000 UTC"><meta property="article:modified_time" content="2024-02-18 00:00:00 IST"><meta property="article:author" content="[lockbox]"><meta property="og:url" content="https://stumbl.ing/wiki/cyclone-v-boot/"><meta property="og:site_name" content="stumbl.ing"><meta property="og:image" content><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><link rel="shortcut icon" href><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Fira+Sans:ital,wght@0,300;0,400;0,500;1,300;1,400;1,500&family=Roboto+Slab:wght@300;400;500&family=Ubuntu+Mono:ital@0;1&display=swap" rel=stylesheet><link href=/wiki/cyclone-v-boot/ rel=alternate type=application/rss+xml title=stumbl.ing><link rel=stylesheet href=https://stumbl.ing/styles.29af3893b7938b7f6bf3bcbb6ce52dcdccce363e03bb52292e3943e8c96a5443.css integrity="sha256-Ka84k7eTi39r87y7bOUtzczONj4Du1IpLjlD6MlqVEM="></head><body><div class=theme-container><div class=container><header class=site-header><nav class=navbar><div class=navbar__first><ul class="navbar__list borders"><li><a href=https://stumbl.ing/>Home</a></li><li><button class="theme-toggle transparent"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></button></li></ul></div><div class=navbar__separator></div><div class=navbar__last><ul class="navbar__list borders menu--desktop"><li><a href=/about/>About</a></li><li><a href=/posts/>Posts</a></li><li><a href=/wiki/>Wiki</a></li></ul><ul class="menu menu--mobile"><li class=menu-trigger>===</li><li><ul class=menu-dropdown><li><a href=/about/>About</a></li><li><a href=/posts/>Posts</a></li><li><a href=/wiki/>Wiki</a></li></ul></li></ul></div></nav></header><main class=site-main><article class=post><header class=post-header><h1 class=post-title><a href=https://stumbl.ing/wiki/cyclone-v-boot/>Simplified Boot Flow for the Cyclone V</a></h1><address class=post-meta><time pubdate datetime="2024-02-18 00:00:00 IST">Published on
2024-02-18 00:00:00 IST
</time><span>by [lockbox]</span>
<time pubdate datetime="2024-02-18 00:00:00 IST">last modified 2024-02-18 00:00:00 IST.</time></address></header><div class=post-content><div class="ox-hugo-toc toc"><div class=heading>Table of Contents</div><ul><li><a href=/#executing-user-software>Executing User Software</a><ul><li><a href=/#preloader-image-requirements>PreLoader Image Requirements</a></li><li><a href=/#preloader-actions>PreLoader Actions</a></li><li><a href=/#preloader-memory-state>PreLoader Memory State</a></li><li><a href=/#bootloader-execution--u-boot>Bootloader execution (u-boot)</a></li><li><a href=/#operating-system-boot>Operating System Boot</a></li></ul></li></ul></div><p>The <a href=https://www.intel.com/content/www/us/en/docs/programmable/683126/21-2/hard-processor-system-technical-reference.html>Cyclone V Technical Reference Manual</a>
details the boot flow for the common &ldquo;running linux to boot your FPGA&rdquo; usecase like so:</p><p><a id="figure--fig: cyclone-v-boot-flow"></a></p><figure class=left><img src=/ox-hugo/manual-boot-flow.png><figcaption class=center><span class=figure-number>Figure 1: </span>Technical Reference Manual Diagram of Typical Boot Flow</figcaption></figure><p>But because everything after the BootROM is classified as &ldquo;user software,&rdquo; there is not much described in the manual.</p><p>What the manual describes as &ldquo;user software&rdquo; still encompasses an entire software stack built,
maintained, and packaged by Altera, but <strong>can</strong> be overriden by the user. As far as behavior and
code that users cannot overwrite go, we are limited to the BootROM.</p><p>The BootROM is described in short on page <code>A-5</code>, and the state machine is fully diagrammed on
page <code>A-27</code>.</p><ul><li>BootROM is 64kb in size</li><li>Located in on-chip ROM at address range <code>0xFFFD_0000</code> to <code>0xFFFD_FFFF</code></li><li>The purpose is to determine the boot source, initialize the HPS after reset, and jump to the PreLoader</li></ul><p>There is a little more nuance if the PreLoader needs to be loaded from flash into RAM. RTFM for more.</p><h2 id=executing-user-software>Executing User Software
<a href=#executing-user-software class=hanchor arialabel=Anchor></a></h2><p>The BootROM&rsquo;s entire purpose is to call the PreLoader, and setup the initial environment necessary for
the PreLoader to be able to load the BootLoader (u-boot) which in turn loads the Operating System (Linux).</p><p>Page <code>A-31</code> details the entry state of the processor on calling the PreLoader:</p><ul><li>I-cache disabled</li><li>Branch Predictor enabled</li><li>D cache disabled</li><li>MMU disabled</li><li>FPU enabled</li><li>NEON enabled</li><li>Processor is in ARM <code>supervisor</code> mode</li></ul><p>Register state:</p><ul><li><code>r0</code>: pointer to shared memory block used to pass information to PreLoader (located in top 4kb of on-chip RAM)</li><li><code>r1</code>: length of the shared memory</li><li><code>r2</code>: set to <code>0x0</code></li><li><code>r3</code>: reserved</li></ul><p>Other system state:</p><ul><li>BootROM is mapped to address <code>0x0</code></li><li><code>L4</code> watchdog timer active and toggled</li><li>Reset cause saved to <code>stat</code> register of the Reset Manager</li><li>Shared memory is setup as described in table <code>A-18</code></li></ul><p>Before the PreLoader can actually be executed, the BootROM validates the PreLoader image after mapping
it into memory at address <code>0xFFFF_0000</code> -> <code>0xFFFF_F000</code>.</p><h3 id=preloader-image-requirements>PreLoader Image Requirements
<a href=#preloader-image-requirements class=hanchor arialabel=Anchor></a></h3><ul><li>Validation word matches magic <code>0x3130_5341</code> (&ldquo;10SA&rdquo;)</li><li>Header version matches</li><li>Header program length (in 32-bit words) from offset 0 to the end of the code area<ul><li>Not including exception vectors or CRC</li></ul></li><li>Checksum of all bytes in the header from offset <code>0x40</code> to <code>0x49</code></li><li>Maximum size of 60 kb (on-chip RAM - 4kb reserved RAM)</li></ul><figure class=left><img src=/ox-hugo/preloader-image-layout.png><figcaption class=center><span class=figure-number>Figure 2: </span>PreLoader Image Layout</figcaption></figure><h3 id=preloader-actions>PreLoader Actions
<a href=#preloader-actions class=hanchor arialabel=Anchor></a></h3><p>The manual very helpfully describes the PreLoader functions as &ldquo;user-defined, however typical functions include &mldr;&rdquo;
But also describes a detailed state machine + order of operations on page <code>A-29</code>.</p><p>TLDR;</p><ul><li>Freeze all I/O banks</li><li>Reset peripherals</li><li>Setup clocks</li><li>Unfreeze all I/O banks</li><li>L3/L4 configuration</li><li>Timer + UART initialization</li><li>SDRAM initialization</li><li>Boot next stage</li></ul><h3 id=preloader-memory-state>PreLoader Memory State
<a href=#preloader-memory-state class=hanchor arialabel=Anchor></a></h3><p>Probably the most helpful thing in the manual so far is this image that shows the state of the memory regions.
In the paragraph before this in the manual, it discusses that until the <code>L3</code> interconnect remap bit 0 is
set high, the exception vectors are still pointing to the exceptions handlers provided by the BootROM.
Setting this bit high remaps the on-chip RAM that the PreLoader is executing with into the 0 page to
successfully splat onto the BootROM handlers.</p><figure class=left><img src=/ox-hugo/preloader-remapping-memory.png><figcaption class=center><span class=figure-number>Figure 3: </span>Memory state of the Cyclone V HPS before and after executing a (compliant) PreLoader</figcaption></figure><p>Comparing this to the <a href=https://developer.arm.com/documentation/den0013/d/Boot-Code/Booting-a-bare-metal-system>ARM Cortex-A booting a bare-metal system guide</a>, we can
start to see some similarities and start to line things up at least as far as code-layout goes.</p><p>The PreLoader (after settting up the respective peripherals), then calls the BootLoader.</p><h3 id=bootloader-execution--u-boot>Bootloader execution (u-boot)
<a href=#bootloader-execution--u-boot class=hanchor arialabel=Anchor></a></h3><p>u-boot is going to do a few main things:</p><ul><li>Get loaded at <code>0xFFFF_0000</code></li><li>Load u-boot scripts that are present</li><li>Find the device tree it is supposed to use</li><li>Execute the kernel with the device tree passed as a parameter</li></ul><p>In the default <a href=https://github.com/altera-opensource/u-boot-socfpga/blob/14e5dc0d59381b43979ab059f1de9cf9afe3645a/configs/socfpga_cyclone5_defconfig>provided-from-altera-open-source u-boot configuration</a>,
there are a few things to note in the `KConfig` for the target:</p><ul><li>booting with SPL u-boot (full blown u-boot), with <code>0xFFFF_0000</code> start address</li><li>default malloc len is size <code>0x4000_0000</code> (1GB)</li><li>u-boot expects to be at specific offsets into the SPI flash device memory</li></ul><p>Looking at the <a href=https://github.com/altera-opensource/u-boot-socfpga/blob/14e5dc0d59381b43979ab059f1de9cf9afe3645a/arch/arm/dts/socfpga_cyclone5_socdk.dts>default device-tree</a> (also provided by Altera),
we can get the list of all the device drivers we need to bake into our linux kernel image (via the &ldquo;compatible&rdquo; attribute in each section),
the size of memory via the <code>memory</code> section, and the default peripherals setups of everything else. Note that you can also describe SRAM
by using the <code>sram</code> section (<code>mmio-sram</code> is the correct driver aiui), and the <code>sdram</code> / <code>mmc</code> blocks as well.</p><p>From there, any <code>u-boot</code> scripts or environment will dictate how linux (and your fpga :p) is actually going to get loaded and executed.
Nowadays you&rsquo;ll probably run into a `bootz` (<a href=https://docs.u-boot.org/en/latest/usage/cmd/bootz.html>docs</a>).</p><h3 id=operating-system-boot>Operating System Boot
<a href=#operating-system-boot class=hanchor arialabel=Anchor></a></h3><p>If you get the default zlinux, then it will self unpack into memory, and then execute the `init` command as specified in your
kernel command line environment.</p><p>And it&rsquo;s done and booted! :D</p></div><footer class=post-footer></footer></article></main><footer class=site-footer><p class=buildinfo><time datetime="2024-02-20 00:32:12 IST">Site built on: 2024-02-20 00:32:12 IST</time></p><div class=copyright><p>© lockbox
2024</p><nav class=navbar><ul class=navbar__list><li><a href=https://stumbl.ing/posts/index.xml>RSS</a></li><li><a href=https://stumbl.ing/sitemap.xml>Sitemap</a></li></ul></nav></div><p class=themeinfo>Powered by <a href=https://gohugo.io>Hugo</a>, using theme <a href=https://manid2.github.io/hugo-xterm/>Hugo Xterm</a>.</p></footer></div></div><script type=text/javascript src=/bundle.min.js></script></body></html>